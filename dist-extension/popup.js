(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();console.log("🚀 Smart Research Tracker Enhanced Popup Loaded");let B="link",p=!1,d=null,I=null;const D=document.getElementById("linkFields"),y=document.getElementById("status"),m=document.getElementById("saveBtn"),l=document.getElementById("labelSelect"),c=document.getElementById("labelInput"),f=document.getElementById("inlineDeleteLabel"),U=typeof chrome<"u"&&chrome.storage&&chrome.storage.local,O=typeof chrome<"u"&&chrome.storage&&chrome.storage.sync;async function x(){try{if(d=(await W({active:!0,currentWindow:!0}))[0],!d||!d.url||d.url.startsWith("chrome://")){s("❌ Cannot save this page type","error"),Y();return}const t=new URL(d.url),n=document.getElementById("currentUrl");n&&(n.textContent=t.hostname),await j(),J(),await H(),await z()}catch(e){console.error("[SRT] Popup initialization failed:",e),s("❌ Failed to initialize popup","error")}}function W(e){return new Promise(t=>{chrome.tabs.query(e,t)})}async function j(){try{const e=await v({autoFillTitle:!0}),t=document.getElementById("title");t&&d?.title&&e.autoFillTitle?(t.value=d.title,t.placeholder="Page title (auto-filled)"):t&&(t.placeholder="Page title")}catch(e){console.debug("[SRT] Title pre-fill failed:",e)}}async function H(){try{const e=await C(["labels","links"]);let t=e.labels||[];const n=Object.prototype.hasOwnProperty.call(e,"labels");if(!t.length&&e.links){const a=new Set;e.links.forEach(o=>{o.label&&a.add(o.label)}),t=Array.from(a)}if(!n&&t.length===0&&(t=["research","article","tutorial","documentation","news","blog"]),d?.id)try{const a=await ee(d.id,{type:"GET_LABELS"});if(a?.labels){const o=a.labels,r=new Set([...t,...o]);t=Array.from(r)}}catch(a){console.debug("[SRT] Content script labels fetch failed:",a)}P(t),await b({labels:t})}catch(e){console.error("[SRT] Label loading failed:",e)}}function P(e){if(!l)return;l.innerHTML="",l.style.display="block",e.forEach(n=>{const a=document.createElement("option");a.value=n,a.textContent=n,l.appendChild(a)});const t=document.createElement("option");t.value="__new",t.textContent="➕ New label…",l.appendChild(t),e.length>0?l.value=e[0]:l.value="__new",f&&(f.disabled=l.value==="__new"),l.value==="__new"&&(l.style.display="none",c.style.display="block",c.focus()),l.onchange=()=>{K(),f&&(f.disabled=l.value==="__new")},f&&(f.onclick=async()=>{try{const n=l?.value;if(!n||n==="__new"){s("Select an existing label first","error");return}const a=await C(["labels","links"]),o=a.links||[],r=o.filter(u=>u.label===n||Array.isArray(u.labels)&&u.labels.includes(n));let i=(a.labels||[]).filter(u=>u!==n);if(r.length>0){if(!confirm(`Label "${n}" is used by ${r.length} link(s). Remove it from those links and delete the label?`)){s("Deletion cancelled","info");return}const w=o.map(k=>{const g={...k};return g.label===n&&(g.label=""),Array.isArray(g.labels)&&(g.labels=g.labels.filter(q=>q!==n)),g});await b({links:w})}await b({labels:i}),P(i),s(`✅ Deleted label "${n}"`,"success")}catch(n){console.error("[SRT] Delete label failed:",n),s("❌ Failed to delete label","error")}})}async function R(){try{let t=(c?.value||"").trim().replace(/[\s\u00A0]+/g," ").replace(/,/g,"").trim();if(!t){c.style.display="none",l.style.display="block";return}t.length>50&&(t=t.slice(0,50));let a=(await C(["labels"])).labels||[];new Set(a.map(r=>r.toLowerCase())).has(t.toLowerCase())||(a.push(t),a.sort((r,i)=>r.localeCompare(i)),await b({labels:a})),P(a),l.value=t,f&&(f.disabled=!1),c.value="",c.style.display="none",l.style.display="block",s(`✅ Added label "${t}"`,"success")}catch{s("❌ Failed to add label","error")}}function J(){c&&(c.onkeydown=e=>{e.key==="Enter"&&(e.preventDefault(),R())},c.oninput=()=>{I&&clearTimeout(I),I=setTimeout(()=>{R()},800)},c.onblur=()=>{c.style.display!=="none"&&R()})}function K(){l.value==="__new"&&(l.style.display="none",c.style.display="block",c.focus())}async function z(){try{(await C(["firstLoad"])).firstLoad||(s('👋 Welcome! Click "Save to Research" to save this page.',"info"),await b({firstLoad:!0}))}catch(e){console.debug("[SRT] Welcome message failed:",e)}}const F=document.querySelectorAll(".cat");F.forEach(e=>{e.addEventListener("click",()=>{F.forEach(t=>t.classList.remove("active")),e.classList.add("active"),B=e.dataset.cat,M()})});function M(){const e=B==="link";D&&(D.style.display=e?"block":"none"),m&&(m.disabled=!e||p)}m?.addEventListener("click",G);async function G(){if(!p)try{if(p=!0,S("🔄 Saving...",!0),console.log("[SRT] Starting save process..."),B!=="link"){s("Only Link saving supported right now.","error");return}console.log("[SRT] Getting form data...");const t=V();console.log("[SRT] Form data:",t),console.log("[SRT] Extracting page data...");const n=await Q();console.log("[SRT] Page data extracted:",{title:n.title,description:n.description,image:n.image,textLength:n.pageText?.length||0});const a={...n,...t,tabId:d?.id};console.log("[SRT] Final payload:",{url:a.url,title:a.title,label:a.label,priority:a.priority,tabId:a.tabId}),h("checking","Checking for duplicates...","Scanning your research library"),console.log("[SRT] Sending to background script...");const o=await $({type:"SAVE_LINK",payload:a});if(console.log("[SRT] Background response:",o),o?.success)h("no-duplicates","✅ No duplicates found!","Link saved successfully"),s("✅ Page saved successfully!","success"),(await v({autoClose:!0})).autoClose&&setTimeout(()=>window.close(),2e3);else if(o?.isDuplicate)console.log("[SRT] Duplicate detected, showing confirmation popup"),h("duplicate-found","⚠️ Duplicate detected!",`${o.duplicateInfo.count} existing link(s) found`),te(a,o.duplicateInfo);else throw console.error("[SRT] Save failed with response:",o),new Error(o?.error||"Save failed")}catch(e){console.error("[SRT] Save failed:",e),console.error("[SRT] Error stack:",e.stack),s(`❌ Failed to save: ${e.message}`,"error"),_()}finally{p=!1,S("Save to Research",!1)}}function V(){const e=document.getElementById("title")?.value||"",t=document.getElementById("priority")?.value||"low",n=document.getElementById("desc")?.value||"";let a="";l&&l.style.display!=="none"&&(a=l.value==="__new"?"":l.value),c&&c.style.display!=="none"&&(a=c.value.trim());const o={url:d?.url||"",title:e,description:n,label:a,priority:t};return console.log("[SRT] Form data extracted:",o),o}async function Q(){try{if(!d?.id)throw new Error("No active tab");const t=(await chrome.scripting.executeScript({target:{tabId:d.id},func:async()=>{try{return window.SRTContentScript?.extractPageData?await window.SRTContentScript.extractPageData():{title:document.title||"",description:document.querySelector('meta[name="description"]')?.content||"",text:document.body?.innerText||"",metadata:{image:document.querySelector('meta[property="og:image"]')?.content||"",author:document.querySelector('meta[name="author"]')?.content||"",publishedTime:document.querySelector('meta[property="article:published_time"]')?.content||"",siteName:document.querySelector('meta[property="og:site_name"]')?.content||""}}}catch(n){return console.error("[SRT] Content script extraction failed:",n),{title:document.title||"",description:document.querySelector('meta[name="description"]')?.content||"",text:document.body?.innerText||"",metadata:{}}}}}))?.[0]?.result||{};return{title:t.title||"",description:t.description||"",pageText:t.text||"",image:t.metadata?.image||"",author:t.metadata?.author||"",publishedTime:t.metadata?.publishedTime||"",siteName:t.metadata?.siteName||"",structuredData:t.structuredData||{}}}catch(e){return console.error("[SRT] Page data extraction failed:",e),{title:"",description:"",pageText:"",image:"",author:"",publishedTime:"",siteName:"",structuredData:{}}}}document.getElementById("openDashboardBtn")?.addEventListener("click",async()=>{try{const e=document.getElementById("openDashboardBtn");A(e,"🔄 Opening...",!0);const t=await v({dashboardUrl:"http://localhost:5174/",fallbackUrl:"https://smartresearchtracker.vercel.app/"}),n=[t.dashboardUrl,t.fallbackUrl];for(const a of n)try{await new Promise((o,r)=>{chrome.tabs.create({url:a},i=>{chrome.runtime.lastError?r(chrome.runtime.lastError):o(i)})}),s("✅ Dashboard opened successfully!","success");return}catch{console.debug("[SRT] Failed to open dashboard at:",a)}s("❌ Could not open dashboard. Check your settings.","error")}catch(e){console.error("[SRT] Dashboard opening failed:",e),s("❌ Failed to open dashboard","error")}finally{const e=document.getElementById("openDashboardBtn");A(e,"Open Dashboard",!1)}});document.getElementById("minimalSettingsBtn")?.addEventListener("click",()=>{const e=document.getElementById("minimalSettingsPanel");e&&(e.style.display="block",X())});document.getElementById("closeMinimalSettings")?.addEventListener("click",()=>{const e=document.getElementById("minimalSettingsPanel");e&&(e.style.display="none")});async function X(){try{const e=await v({dashboardUrl:"http://localhost:5174/",autoFillTitle:!0,autoClose:!0}),t=document.getElementById("minimalDashboardUrl"),n=document.getElementById("minimalAutoFill"),a=document.getElementById("minimalAutoClose");t&&(t.value=e.dashboardUrl),n&&(n.checked=e.autoFillTitle),a&&(a.checked=e.autoClose)}catch(e){console.error("[SRT] Settings loading failed:",e)}}document.getElementById("saveMinimalSettings")?.addEventListener("click",async()=>{try{const e={dashboardUrl:document.getElementById("minimalDashboardUrl")?.value?.trim()||"http://localhost:5174/",autoFillTitle:document.getElementById("minimalAutoFill")?.checked||!1,autoClose:document.getElementById("minimalAutoClose")?.checked||!1};await Z(e),s("✅ Settings saved!","success"),setTimeout(()=>{const t=document.getElementById("minimalSettingsPanel");t&&(t.style.display="none")},1500)}catch(e){console.error("[SRT] Settings save failed:",e),s("❌ Failed to save settings","error")}});document.getElementById("openFullSettingsFromMinimal")?.addEventListener("click",()=>{chrome.runtime.openOptionsPage(()=>{chrome.runtime.lastError&&chrome.tabs.create({url:"chrome://extensions/?id="+chrome.runtime.id})})});function s(e,t="info"){y&&(y.textContent=e,y.className=`status ${t}`,y.style.display="block",t==="success"&&setTimeout(()=>{y.style.display="none"},2e3))}function S(e,t){m&&(m.textContent=e,m.disabled=t)}function A(e,t,n){e&&(e.textContent=t,e.disabled=n)}function Y(){m&&(m.disabled=!0,m.textContent="Cannot Save")}function v(e){return O?new Promise(t=>{chrome.storage.sync.get(e,t)}):(e&&Object.keys(e).forEach?.(()=>{}),Promise.resolve({dashboardUrl:localStorage.getItem("srt_dashboardUrl")||"http://localhost:5174/",autoFillTitle:localStorage.getItem("srt_autoFillTitle")==="true",autoClose:localStorage.getItem("srt_autoClose")!=="false"}))}function Z(e){return O?new Promise(t=>{chrome.storage.sync.set(e,t)}):(e.dashboardUrl&&localStorage.setItem("srt_dashboardUrl",e.dashboardUrl),typeof e.autoFillTitle<"u"&&localStorage.setItem("srt_autoFillTitle",String(e.autoFillTitle)),typeof e.autoClose<"u"&&localStorage.setItem("srt_autoClose",String(e.autoClose)),Promise.resolve())}function C(e){if(U)return new Promise(n=>{chrome.storage.local.get(e,n)});const t={};return Array.isArray(e)&&e.forEach(n=>{n==="labels"?t.labels=JSON.parse(localStorage.getItem("srt_labels")||"[]"):n==="links"?t.links=JSON.parse(localStorage.getItem("srt_links")||"[]"):n==="firstLoad"&&(t.firstLoad=localStorage.getItem("srt_firstLoad")==="true")}),Promise.resolve(t)}function b(e){return U?new Promise(t=>{chrome.storage.local.set(e,t)}):(e.labels&&localStorage.setItem("srt_labels",JSON.stringify(e.labels)),e.links&&localStorage.setItem("srt_links",JSON.stringify(e.links)),typeof e.firstLoad<"u"&&localStorage.setItem("srt_firstLoad",String(e.firstLoad)),Promise.resolve())}function $(e){return new Promise((t,n)=>{console.log("[SRT] Sending message to background:",e.type);try{if(typeof chrome>"u"||!chrome.runtime?.sendMessage)return t({success:!1,error:"background_unavailable"});chrome.runtime.sendMessage(e,a=>{chrome.runtime.lastError?(console.error("[SRT] Background message error:",chrome.runtime.lastError),n(new Error(chrome.runtime.lastError.message||"Background script error"))):(console.log("[SRT] Background message response:",a),t(a))})}catch(a){console.error("[SRT] Message sending failed:",a),n(a)}})}async function N(e){try{const t=await chrome.scripting.executeScript({target:{tabId:e},func:()=>{try{return!!(window.SRTContentScript||window.smartResearchTracker||window.__SMART_RESEARCH_TRACKER__)}catch{return!1}}});if(Array.isArray(t)?!!t[0]?.result:!!t)return!0}catch{}try{return await chrome.scripting.executeScript({target:{tabId:e},files:["contentScript.js"]}),!0}catch(t){return console.warn("[SRT] Content script injection failed:",t?.message||t),!1}}function ee(e,t){return new Promise((n,a)=>{console.log("[SRT] Sending message to tab:",e,t.type),chrome.tabs.get(e,async o=>{if(chrome.runtime.lastError){console.warn("[SRT] Tab not accessible:",chrome.runtime.lastError.message),a(new Error("Tab not accessible"));return}if(!o.url||o.url.startsWith("chrome://")||o.url.startsWith("chrome-extension://")){console.warn("[SRT] Cannot send message to this tab type:",o.url),a(new Error("Cannot send message to this tab type"));return}const r=async(i=1)=>{i===1&&await N(e);try{chrome.tabs.sendMessage(e,t,async u=>{if(chrome.runtime.lastError){const w=chrome.runtime.lastError.message||"";console.warn(`[SRT] Tab message error (attempt ${i}):`,w);const k=/Receiving end does not exist|Could not establish connection/i.test(w);if(i===1&&k&&await N(e)){setTimeout(()=>r(2),150);return}n({success:!1,error:"content_script_unavailable"})}else console.log("[SRT] Tab message response:",u),n(u)})}catch(u){console.error("[SRT] Tab message sending failed:",u),n({success:!1,error:"content_script_unavailable"})}};r(1)})})}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",x):x();M();let E=null,T=null;function h(e,t,n){const a=document.getElementById("duplicateStatus");if(!a)return;a.className=`duplicate-status ${e}`;const o=a.querySelector(".duplicate-status-title"),r=a.querySelector(".duplicate-status-details");o&&(o.textContent=t),r&&(r.textContent=n),a.style.display="flex"}function _(){const e=document.getElementById("duplicateStatus");e&&(e.style.display="none")}function te(e,t){E=e,T=t,document.getElementById("duplicateCount").textContent=t.count;const n=document.getElementById("duplicateList");n.innerHTML="",t.duplicates.forEach(a=>{const o=document.createElement("div");o.className="duplicate-item";const r=document.createElement("div");r.className="duplicate-item-title",r.textContent=a.title||"Untitled";const i=document.createElement("div");i.className="duplicate-item-details",i.innerHTML=`
      <div>URL: ${a.url}</div>
      <div>Labels: ${Array.isArray(a.labels)?a.labels.join(", "):a.labels||"research"}</div>
      <div>Priority: ${a.priority||"medium"}</div>
      <div>Status: ${a.status||"active"}</div>
      <div>Created: ${new Date(a.createdAt).toLocaleDateString()}</div>
    `,o.appendChild(r),o.appendChild(i),n.appendChild(o)}),document.getElementById("duplicatePopup").style.display="flex",p=!1,S("Save to Research",!1)}function L(){document.getElementById("duplicatePopup").style.display="none",E=null,T=null,_()}async function ae(){if(!(!E||!T))try{p=!0,S("🔄 Saving...",!0),console.log("[SRT] User confirmed saving duplicate link");const e=await $({type:"SAVE_LINK_CONFIRMED",payload:E,duplicateInfo:T});if(e?.success)h("no-duplicates","✅ Link saved successfully!","User confirmed saving despite duplicates"),s("✅ Page saved successfully!","success"),L(),(await v({autoClose:!0})).autoClose&&setTimeout(()=>window.close(),2e3);else throw new Error(e?.error||"Save failed")}catch(e){console.error("[SRT] Save anyway failed:",e),s(`❌ Failed to save: ${e.message}`,"error")}finally{p=!1,S("Save to Research",!1)}}function ne(){L(),h("duplicate-found","❌ Save cancelled","User chose not to save duplicate link"),s("❌ Save cancelled","info"),setTimeout(()=>{_()},3e3)}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("closeDuplicatePopup")?.addEventListener("click",L),document.getElementById("saveAnywayBtn")?.addEventListener("click",ae),document.getElementById("cancelSaveBtn")?.addEventListener("click",ne),document.getElementById("duplicatePopup")?.addEventListener("click",e=>{e.target.id==="duplicatePopup"&&L()})});
