console.log("[Smart Research Tracker] Enhanced content script loaded");function p(){try{document.documentElement.setAttribute("data-smart-research-tracker","true"),document.documentElement.setAttribute("data-extension","smart-research-tracker");const e="srt-extension-marker";if(!document.getElementById(e)){const a=document.createElement("meta");a.id=e,a.setAttribute("data-smart-research-tracker","true"),a.setAttribute("data-extension","smart-research-tracker"),a.content="installed",document.documentElement.appendChild(a)}document.dispatchEvent(new CustomEvent("smart-research-tracker-ready",{detail:{source:"smart-research-tracker-extension"}})),window.addEventListener("message",a=>{try{if((a?.data||{}).type!=="SRT_PING")return;const r=chrome?.runtime?.getManifest&&chrome.runtime.getManifest()||{};window.postMessage({type:"SRT_PONG",extensionId:chrome?.runtime?.id||"",source:"smart-research-tracker-extension",status:"ok",message:"Extension is working",version:r.version||"",timestamp:Date.now()},"*")}catch{}})}catch(e){console.debug("[SRT] Presence exposure failed:",e)}}p();try{chrome.runtime?.sendMessage?.({type:"CS_READY"})}catch{}window.addEventListener("load",()=>{try{chrome.runtime?.sendMessage?.({type:"CS_READY"})}catch{}});try{const e=window.name||"";if(typeof e=="string"&&e.startsWith("SRT_PASTE::")){const a=e.slice(11);try{const t=decodeURIComponent(escape(atob(a))),r=()=>{const o=["textarea",'textarea[placeholder*="Message"]','textarea[placeholder*="Send a message"]','[contenteditable="true"][role="textbox"]','[contenteditable="true"]'];let n=null;for(const s of o){const c=document.querySelector(s);if(c&&(c.offsetWidth||c.offsetHeight)){n=c;break}}n?(n.focus(),n instanceof HTMLTextAreaElement||n instanceof HTMLInputElement?(n.value=t,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0}))):n instanceof HTMLElement&&n.contentEditable==="true"&&(n.textContent=t,n.dispatchEvent(new Event("input",{bubbles:!0}))),console.log("[SRT] Auto-paste applied from window.name payload")):(console.log("[SRT] No input found yet, retrying..."),setTimeout(r,1500))};setTimeout(r,2500)}catch(t){console.log("[SRT] Failed to decode payload:",t)}try{window.name=""}catch{}}}catch(e){console.log("[SRT] window.name inspection failed:",e)}try{window.__SRT_cachedLinks||(window.__SRT_cachedLinks=[])}catch{}var i=typeof window<"u"&&window.__SRT_cachedLinks||[];try{typeof window<"u"&&(window.__SRT_cachedLinks=i)}catch{}function l(){try{return i&&i.length?i:[]}catch{return[]}}function d(e){try{i=Array.isArray(e)?e:[]}catch{i=[]}try{typeof chrome<"u"&&chrome.storage?.local?.set&&chrome.storage.local.set({links:i},()=>{})}catch{}}try{typeof chrome<"u"&&chrome.storage?.local?.get&&(chrome.storage.local.get(["links"],e=>{i=e?.links||[]}),chrome.storage?.onChanged?.addListener?.((e,a)=>{a==="local"&&e.links&&(i=e.links.newValue||[])}))}catch{}async function u(e){return new Promise(a=>{try{chrome.storage.local.get(["links"],t=>{const r=t?.links||[],o=s=>String(s||"").replace(/\/+$/,"").toLowerCase();if(r.some(s=>o(s.url)===o(e.url))){const s=r.findIndex(c=>o(c.url)===o(e.url));r[s]={...r[s],...e,updatedAt:new Date().toISOString()}}else r.push(e);chrome.storage.local.set({links:r},()=>{i=r;try{window.postMessage({type:"SRT_DB_UPDATED"},"*")}catch{}a({success:!0,link:e})})})}catch(t){console.debug("[SRT] addLinkFallback failed:",t),a({success:!1,error:String(t)})}})}async function S(e){return new Promise(a=>{try{chrome.storage.local.get(["summaries"],t=>{const r=t?.summaries||[];r.push(e),chrome.storage.local.set({summaries:r},()=>a({success:!0,summary:e}))})}catch(t){console.debug("[SRT] addSummaryFallback failed:",t),a({success:!1,error:String(t)})}})}async function m(){return new Promise(e=>{try{chrome.storage.local.remove(["links","pendingUpserts","labels","summaries"],()=>{i=[];try{window.postMessage({type:"SRT_DB_UPDATED"},"*")}catch{}e({success:!0})})}catch(a){console.debug("[SRT] clearAllDataFallback failed:",a),e({success:!1,error:String(a)})}})}chrome.runtime.onMessage.addListener((e,a,t)=>(console.log("[SRT] Received message:",e.type),f(e,a,t),!0));function f(e,a,t){switch(e.type){case"GET_LABELS":try{const r=l(),o=new Set;(r||[]).forEach(n=>Array.isArray(n.labels)&&n.labels.forEach(s=>o.add(String(s)))),t?.({labels:Array.from(o)})}catch{t?.({labels:[]})}break;case"UPSERT_LINK":_(e.link,e.summaries||[]).then(r=>t?.(r)).catch(r=>{console.error("[SRT] UPSERT_LINK error:",r),t?.({success:!1,error:r.message})});break;case"ADD_LINK":T(e.payload).then(r=>t?.(r)).catch(r=>{console.error("[SRT] ADD_LINK error:",r),t?.({success:!1,error:r.message})});break;case"ADD_SUMMARY":w(e.payload).then(r=>t?.(r)).catch(r=>{console.error("[SRT] ADD_SUMMARY error:",r),t?.({success:!1,error:r.message})});break;case"SRT_GET_DISPLAYED_LINKS":try{const r=l();console.log("[SRT] Background checking displayed links, current count:",r.length),t?.({links:r})}catch(r){console.debug("[SRT] Error getting displayed links:",r),t?.({links:[]})}break;case"CLEAR_ALL_DATA":m().then(r=>t?.(r)).catch(r=>t?.({success:!1,error:String(r)}));break;default:console.warn("[SRT] Unknown message type:",e.type),t?.({success:!1,error:"Unknown message type"});break}}async function _(e,a=[]){try{const t={id:e.id||crypto.randomUUID(),url:String(e.url||""),metadata:{title:String(e.metadata?.title||""),description:String(e.metadata?.description||""),image:String(e.metadata?.image||""),author:String(e.metadata?.author||""),publishedTime:String(e.metadata?.publishedTime||""),siteName:String(e.metadata?.siteName||"")},labels:Array.isArray(e.labels)?e.labels.map(String):["research"],priority:String(e.priority||"medium"),status:String(e.status||"active"),boardId:e.boardId||null,createdAt:e.createdAt||new Date().toISOString(),updatedAt:new Date().toISOString()};if(console.log("[SRT] Saving link using fallback storage:",t.url),console.log("[SRT] Link metadata:",t.metadata),console.log("[SRT] Link labels:",t.labels),console.log("[SRT] Link status:",t.status),console.log("[SRT] Link created:",t.createdAt),console.log("[SRT] Full link object:",t),(await u(t)).success&&a.length>0){const o=a.map(n=>({id:n.id||crypto.randomUUID(),linkId:t.id,kind:String(n.kind||"raw"),content:String(n.content||""),embedding:null,createdAt:n.createdAt||new Date().toISOString()}));await Promise.all(o.map(n=>new Promise(s=>{chrome.storage.local.get(["summaries"],c=>{const g=c.summaries||[];g.push(n),chrome.storage.local.set({summaries:g},s)})})))}try{window.postMessage({type:"SRT_UPSERT_LINK",link:t},"*"),document.dispatchEvent(new CustomEvent("srt-upsert-link",{detail:{link:t}}))}catch{}return{success:!0,link:t}}catch(t){throw console.error("[SRT] UPSERT_LINK failed:",t),console.error("[SRT] Error details:",{message:t.message,name:t.name,stack:t.stack}),t}}async function T(e){try{const a=await u(e);return{ok:!!a?.success,link:a?.link}}catch(a){throw console.error("[SRT] ADD_LINK failed:",a),a}}async function w(e){try{const a=await S(e);try{window.postMessage({type:"SRT_ADD_SUMMARY",summary:e},"*"),document.dispatchEvent(new CustomEvent("srt-add-summary",{detail:{summary:e}}))}catch{}return{ok:a.success,summary:a.summary}}catch(a){throw console.error("[SRT] ADD_SUMMARY failed:",a),a}}async function k(){try{document.readyState!=="complete"&&await new Promise(r=>{window.addEventListener("load",r,{once:!0})}),await b();const e=h(),a=await R(),t=y();return{title:t.title,description:t.description,text:a,structuredData:e,metadata:t}}catch(e){return console.error("[SRT] Page data extraction failed:",e),{title:document.title||"",description:"",text:document.body?.innerText||"",structuredData:{},metadata:{}}}}async function b(){try{['button:contains("Read more")','button:contains("Show more")','a:contains("Continue reading")','[aria-expanded="false"]',".collapsed",".expandable"].forEach(a=>{try{document.querySelectorAll(a).forEach(r=>{r.offsetParent!==null&&r.click()})}catch{}});for(let a=0;a<3;a++)window.scrollTo(0,document.body.scrollHeight),await new Promise(t=>setTimeout(t,500))}catch(e){console.debug("[SRT] Auto-expand failed:",e)}}function h(){try{const e=document.querySelectorAll('script[type="application/ld+json"]'),a=[];return e.forEach(t=>{try{const r=JSON.parse(t.textContent);a.push(r)}catch{}}),a}catch(e){return console.debug("[SRT] Structured data extraction failed:",e),[]}}function y(){const e={title:document.title||"",description:"",keywords:"",author:"",publishedTime:"",modifiedTime:"",image:"",siteName:""};return Object.entries({description:"description",keywords:"keywords",author:"author","article:published_time":"publishedTime","article:modified_time":"modifiedTime","og:title":"title","og:description":"description","og:image":"image","og:site_name":"siteName","twitter:title":"title","twitter:description":"description","twitter:image":"image"}).forEach(([t,r])=>{const o=document.querySelector(`meta[name="${t}"], meta[property="${t}"]`);o?.content&&(e[r]=o.content)}),e}async function R(){try{const e=await E();return e.length>1e3?e:A()}catch(e){return console.debug("[SRT] Text extraction failed:",e),document.body?.innerText||""}}async function E(){return""}function A(){try{const e=["main","article",".content",".post-content",".entry-content",".article-content",".story-content",".main-content"];let a="";for(const t of e){const r=document.querySelector(t);if(r&&(a=r.innerText,a.length>500))break}return(!a||a.length<500)&&(a=document.body?.innerText||""),L(a)}catch(e){return console.debug("[SRT] Manual text extraction failed:",e),document.body?.innerText||""}}function L(e){if(!e)return"";const a=[/get the .*app/i,/subscribe.*substack/i,/^share .*twitter$/i,/advertisement/i,/sponsored/i,/sign up/i,/newsletter/i];return e.split(`
`).filter(t=>{const r=t.trim();return!(!r||r.split(/\s+/).length<4||a.some(o=>o.test(r)))}).join(`
`).slice(0,5e5)}window.addEventListener("message",e=>{if(e.data?.type==="SRT_PING")try{const a=chrome?.runtime?.getManifest&&chrome.runtime.getManifest()||{};window.postMessage({type:"SRT_PONG",extensionId:chrome?.runtime?.id||"",source:"smart-research-tracker-extension",status:"ok",version:a.version||"",timestamp:Date.now()},"*")}catch{}if(e.data?.type==="SRT_CLEAR_ALL_LINKS"&&(console.log("[SRT] Clearing all data..."),m()),e.data?.type==="SRT_GET_LINKS"){const a=e.data.messageId,t=n=>{try{window.postMessage({type:"SRT_LINKS_RESPONSE",messageId:a,links:n},"*")}catch{}},r=()=>new Promise(n=>{try{chrome.runtime.sendMessage({type:"GET_LINKS"},s=>{if(Array.isArray(s?.links))return n(s.links);n(null)})}catch{n(null)}}),o=()=>new Promise(n=>{try{chrome.storage?.local?.get?.(["links"],s=>n(s?.links||null))}catch{n(null)}});(async()=>{let n=await r();if((!n||n.length===0)&&(n=await o()),!n||n.length===0)try{n=l()}catch{n=[]}console.log("[SRT] Dashboard requested links, sending",(n||[]).length,"links"),t(n||[])})()}if(e.data?.type==="SRT_GET_DISPLAYED_LINKS")try{const a=l();console.log("[SRT] Background checking displayed links, current count:",a.length);try{window.postMessage({type:"SRT_DISPLAYED_LINKS_RESPONSE",links:a},"*")}catch{}}catch(a){console.debug("[SRT] Error getting displayed links:",a);try{window.postMessage({type:"SRT_DISPLAYED_LINKS_RESPONSE",links:[]},"*")}catch{}}if(e.data?.type==="SRT_UPDATE_LINKS_STATUS")try{const t=l().map(r=>{const o=e.data.links.find(n=>n.id===r.id);return o?{...r,status:o.status}:r});d(t),console.log("[SRT] Updated link statuses (cached/local)")}catch{}if(e.data?.type==="SRT_UPDATE_LINK"){const{id:a,changes:t,messageId:r}=e.data||{};try{const n=l().map(s=>{if(s.id===a){const c={...s,...t,updatedAt:new Date().toISOString()};return t?.metadata&&(c.metadata={...s.metadata,...t.metadata}),t?.labels&&(c.labels=Array.isArray(t.labels)?t.labels:s.labels),c}return s});d(n);try{window.postMessage({type:"SRT_DB_UPDATED"},"*")}catch{}try{window.postMessage({type:"SRT_UPDATE_LINK_OK",messageId:r},"*")}catch{}}catch{}}if(e.data?.type==="SRT_REMOVE_LINK"){const{id:a,messageId:t}=e.data||{};try{const o=l().filter(n=>n.id!==a);d(o);try{window.postMessage({type:"SRT_DB_UPDATED"},"*")}catch{}try{window.postMessage({type:"SRT_REMOVE_LINK_OK",messageId:t},"*")}catch{}}catch{}}if(e.data?.type==="SRT_ADD_LINK"){const{link:a,messageId:t}=e.data||{};try{const r=l(),o=s=>(s||"").toString().replace(/\/+$/,"").toLowerCase(),n=r.findIndex(s=>o(s.url)===o(a?.url)||s.id===a?.id);n===-1&&a?r.push(a):n!==-1&&a&&(r[n]={...r[n],...a,updatedAt:new Date().toISOString()}),d(r);try{window.postMessage({type:"SRT_DB_UPDATED"},"*")}catch{}try{window.postMessage({type:"SRT_ADD_LINK_OK",messageId:t},"*")}catch{}}catch{}}});console.log("[SRT] Using fallback storage (chrome.storage.local) - no IndexedDB initialization needed");typeof window<"u"&&(window.SRTContentScript={addLinkFallback:u,addSummaryFallback:S,clearAllDataFallback:m,extractPageData:k,extractStructuredData:h,extractMetadata:y});
