chrome.runtime.onMessage.addListener((s,l,d)=>{if(s.type==="CLEAR_ALL_LINKS")return chrome.storage.local.remove(["pendingUpserts","links"],()=>{d?.({ok:!0})}),!0;if(s.type==="SAVE_LINK"){const o=s.payload,a={id:crypto.randomUUID(),url:o.url,metadata:{title:o.title||"",description:o.description||"",image:""},labels:o.label?[o.label]:[],priority:o.priority||"low",status:"active",createdAt:new Date,updatedAt:new Date,boardId:o.boardId||null};chrome.storage.local.get(["links"],r=>{const e=r.links||[],t=o.url.replace(/\/+$/,"").toLowerCase();e.some(i=>(i.url||"").replace(/\/+$/,"").toLowerCase()===t)?console.debug?.("Duplicate link ignored",o.url):e.push({...o,savedAt:Date.now(),id:a.id}),chrome.storage.local.set({links:e},()=>{console.log("Link saved to chrome.storage",o),chrome.action.setBadgeText({text:e.length.toString()}),chrome.action.setBadgeBackgroundColor({color:"#10b981"}),d?.({ok:!0})}),o.label&&chrome.storage.local.get(["labels"],i=>{const c=new Set(i.labels||[]);c.add(o.label),chrome.storage.local.set({labels:Array.from(c)})})});const h=["http://localhost:5173/*","https://smartresearchtracker.vercel.app/*"],m=r=>{chrome.storage.local.get(["pendingUpserts"],e=>{const t=e.pendingUpserts||[];t.push(r),chrome.storage.local.set({pendingUpserts:t})})};setInterval(()=>{chrome.storage.local.get(["pendingUpserts"],r=>{const e=r.pendingUpserts||[];e.length&&chrome.tabs.query({url:h},t=>{if(!t.length)return;const n=t[0].id;if(n===void 0)return;e.splice(0,e.length).forEach(c=>{chrome.tabs.sendMessage(n,c,()=>{chrome.runtime.lastError&&e.push(c),chrome.storage.local.set({pendingUpserts:e})})})})})},3e4);const u=(r,e=[])=>{chrome.tabs.query({url:h},t=>{if(!t.length){m({type:"UPSERT_LINK",link:r,summaries:e});return}t.forEach(n=>{n.id!==void 0&&chrome.tabs.sendMessage(n.id,{type:"UPSERT_LINK",link:r,summaries:e},()=>{chrome.runtime.lastError&&(console.debug?.("UPSERT_LINK send error",chrome.runtime.lastError.message),m({type:"UPSERT_LINK",link:r,summaries:e}))})})})};u(a,[]);const p=r=>{u(a,[r])},b=r=>{chrome.storage.local.get(["apiBase"],e=>{r(e.apiBase||"https://smartresearchtracker.vercel.app")})},k=r=>{b(e=>{fetch(`${e.replace(/\/$/,"")}/api/enrich`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({linkId:a.id,url:a.url,text:r})}).then(t=>t.json()).then(t=>{if(!t?.summary)return;const n={id:crypto.randomUUID(),linkId:a.id,kind:"tldr",content:t.summary,embedding:t.embeddings?.[0]||void 0,createdAt:new Date,updatedAt:new Date};p(n)}).catch(t=>console.debug?.("enrich fetch error",t))})};let g=o.pageText||"";const f=r=>{if(!r)return;const e={id:crypto.randomUUID(),linkId:a.id,kind:"raw",content:r,createdAt:new Date,updatedAt:new Date};p(e),k(r)};if(g)f(g.slice(0,5e5));else{const r=o.tabId;r!==void 0&&chrome.scripting.executeScript({target:{tabId:r},func:()=>document.body.innerText.slice(0,5e5)},async e=>{let t="";if(chrome.runtime.lastError?console.debug?.("executeScript error:",chrome.runtime.lastError.message):t=e?.[0]?.result||"",!t)try{const n=a.url.replace(/^https?:\/\//,"");t=(await fetch(`https://r.jina.ai/http://${n}`).then(c=>c.ok?c.text():"")).slice(0,5e5)}catch(n){console.debug?.("jina.ai fetch failed",n)}f(t)})}return!0}});chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.removeAll(()=>{chrome.contextMenus.create({id:"openDashboard",title:"ðŸ“Š Open Smart Research Dashboard",contexts:["action","page","selection"]}),chrome.contextMenus.create({id:"saveToResearch",title:"ðŸ’¾ Save to Smart Research",contexts:["page","link","selection"]})}),chrome.storage.local.get(["links"],s=>{const l=s.links||[];chrome.action.setBadgeText({text:l.length.toString()}),chrome.action.setBadgeBackgroundColor({color:"#10b981"})})});chrome.contextMenus.onClicked.addListener((s,l)=>{s.menuItemId==="openDashboard"?chrome.tabs.create({url:"http://localhost:5173/"},d=>{chrome.runtime.lastError&&chrome.tabs.create({url:"https://smartresearchtracker.vercel.app/"},o=>{chrome.runtime.lastError&&chrome.notifications.create({type:"basic",iconUrl:"icons/icon.svg",title:"Smart Research Tracker",message:"Could not open dashboard. Make sure the app is running."})})}):s.menuItemId==="saveToResearch"&&chrome.action.openPopup()});chrome.runtime.onInstalled.addListener(()=>{chrome.notifications&&chrome.notifications.getPermissionLevel(s=>{s==="denied"&&console.log("Notification permission denied")})});
