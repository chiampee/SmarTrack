# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
# JFrog SAST performs 1st party source code security analysis
# For more information, see
# https://docs.jfrog-applications.jfrog.io/jfrog-security-features/sast

name: "JFrog SAST Scan"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '23 5 * * 4'
  workflow_dispatch:

env:
  # [Optional - Workflow will skip if not configured]
  # JFrog platform URL and access token for
  # a JFrog platform instance with active
  # JFrog Advanced Security subscription
  # To enable: Add JF_URL and JF_ACCESS_TOKEN to GitHub repository secrets
  JF_URL: ${{ secrets.JF_URL }}
  JF_TOKEN: ${{ secrets.JF_ACCESS_TOKEN }}

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    # Skip job if JFrog secrets are not configured
    if: ${{ secrets.JF_URL != '' && secrets.JF_ACCESS_TOKEN != '' }}
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install and configure JFrog CLI
      run: |
        npm install -g jfrog-cli-v2-jf
        echo "${{ secrets.JF_ACCESS_TOKEN }}" | jf c add --interactive=false --url="${{ secrets.JF_URL }}" --access-token-stdin

    - name: Run JFrog SAST
      run: |
        jf audit --sast --format=sarif > jfrog_sast.sarif || true
        # Continue even if audit finds issues (they'll be reported in SARIF)

    - name: Upload output to generate autofix
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: jfrog_sast.sarif
        wait-for-processing: false

  skip-notice:
    name: Skip Notice
    runs-on: ubuntu-latest
    # Only run if secrets are NOT configured
    if: ${{ secrets.JF_URL == '' || secrets.JF_ACCESS_TOKEN == '' }}
    steps:
    - name: Notice
      run: |
        echo "⚠️ JFrog SAST scan skipped: JF_URL and/or JF_ACCESS_TOKEN secrets not configured"
        echo "To enable JFrog SAST scanning:"
        echo "1. Sign up for JFrog Advanced Security at https://jfrog.com"
        echo "2. Get your JFrog platform URL and access token"
        echo "3. Add secrets to GitHub: Settings → Secrets and variables → Actions"
        echo "   - Add secret: JF_URL (your JFrog platform URL)"
        echo "   - Add secret: JF_ACCESS_TOKEN (your JFrog access token)"
