name: Keep Backend Warm

on:
  schedule:
    # Run every 15 minutes (less load on GitHub runners = fewer "runner not acquired" errors)
    - cron: '*/15 * * * *'
  workflow_dispatch: # Allow manual trigger

# Cancel in-progress runs when a new one starts (avoid queue buildup)
concurrency:
  group: keep-backend-warm
  cancel-in-progress: true

jobs:
  ping-backend:
    runs-on: ubuntu-22.04
    timeout-minutes: 2
    # Don't fail the workflow when GitHub has runner/infra issues (you'll still see the job as failed)
    continue-on-error: true
    steps:
      - name: Ping Backend Health Endpoint
        run: |
          echo "Pinging backend at $(date)"
          response=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 30 https://smartrack-back.onrender.com/api/health || echo "000")
          if [ "${response}" = "200" ]; then
            echo "✅ Backend is warm (HTTP $response)"
          else
            echo "⚠️ Backend returned HTTP ${response:-no response}"
          fi
      
      - name: Ping Root Endpoint
        run: |
          curl -s --connect-timeout 10 --max-time 30 https://smartrack-back.onrender.com/ || echo "Root endpoint ping failed"
