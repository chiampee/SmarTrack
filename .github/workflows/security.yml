name: Security Scanning

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  # NPM Dependency Vulnerability Scanning
  npm-security-scan:
    name: NPM Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Snyk security scan (npm)
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --fail-on=upgradable

  # Python Dependency Vulnerability Scanning
  python-security-scan:
    name: Python Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Snyk security scan (Python)
        uses: snyk/actions/python@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --fail-on=upgradable --file=backend/requirements.txt
          command: test

  # Python Code Security Scanning with Bandit
  bandit-scan:
    name: Run Bandit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Bandit
        continue-on-error: true
        working-directory: ./backend
        run: |
          pip install bandit
          bandit -r . -x .venv -x venv

  # Python Dependency Vulnerability Scanning with Safety
  safety-scan:
    name: Safety Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Run Safety
        continue-on-error: true
        working-directory: ./backend
        run: |
          pip install safety
          safety check --file requirements.txt

  # License Compliance Scanning
  license-compliance:
    name: License Compliance Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Snyk license check (npm)
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: test --severity-threshold=high --fail-on=upgradable --json-file-output=snyk-npm-results.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Snyk license check (Python)
        uses: snyk/actions/python@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: test --severity-threshold=high --fail-on=upgradable --json-file-output=snyk-python-results.json --file=backend/requirements.txt
          command: test

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check for license violations
        continue-on-error: true
        run: |
          echo "## License Compliance Report" >> $GITHUB_STEP_SUMMARY
          if [ -f snyk-npm-results.json ]; then
            echo "### NPM Licenses" >> $GITHUB_STEP_SUMMARY
            jq -r '.licensesPolicy?.licenses[]? | "\(.license) - \(.severity)"' snyk-npm-results.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No license issues found in npm dependencies" >> $GITHUB_STEP_SUMMARY
          else
            echo "### NPM Licenses" >> $GITHUB_STEP_SUMMARY
            echo "No license scan results available" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f snyk-python-results.json ]; then
            echo "### Python Licenses" >> $GITHUB_STEP_SUMMARY
            jq -r '.licensesPolicy?.licenses[]? | "\(.license) - \(.severity)"' snyk-python-results.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No license issues found in Python dependencies" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Python Licenses" >> $GITHUB_STEP_SUMMARY
            echo "No license scan results available" >> $GITHUB_STEP_SUMMARY
          fi

  # Docker Image Scanning (if Dockerfile exists)
  docker-scan:
    name: Docker Image Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Dockerfile
        id: check-dockerfile
        run: |
          if [ -f Dockerfile ] || [ -f docker-compose.yml ] || find . -name "Dockerfile*" -type f | grep -q .; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Build Docker image
        if: steps.check-dockerfile.outputs.exists == 'true'
        run: |
          if [ -f Dockerfile ]; then
            docker build -t smartrack:test .
          fi

      - name: Run Snyk container scan
        if: steps.check-dockerfile.outputs.exists == 'true'
        uses: snyk/actions/docker@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: smartrack:test
          args: --severity-threshold=high

  # Security Summary
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [npm-security-scan, python-security-scan, bandit-scan, safety-scan, license-compliance]
    if: always()
    steps:
      - name: Generate security summary
        run: |
          echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "- NPM Security Scan: ${{ needs.npm-security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Python Security Scan: ${{ needs.python-security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Bandit Security Scan: ${{ needs.bandit-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Safety Check: ${{ needs.safety-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- License Compliance: ${{ needs.license-compliance.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View detailed results in the Security tab of this repository." >> $GITHUB_STEP_SUMMARY
