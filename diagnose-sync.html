<!DOCTYPE html>
<html>
<head>
  <title>Sync Diagnostic Tool</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1200px; margin: 0 auto; }
    .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
    .success { background: #d4edda; border-color: #c3e6cb; }
    .error { background: #f8d7da; border-color: #f5c6cb; }
    .warning { background: #fff3cd; border-color: #ffeaa7; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
    .step { margin: 10px 0; padding: 10px; border-left: 3px solid #007bff; }
    .check { display: inline-block; width: 20px; height: 20px; margin-right: 10px; }
    .check.yes { color: green; }
    .check.no { color: red; }
  </style>
</head>
<body>
  <h1>üîç Extension ‚ÜîÔ∏è Dashboard Sync Diagnostic</h1>
  
  <div class="section">
    <h2>Step 1: Check Environment</h2>
    <div id="env-check"></div>
    <button onclick="checkEnvironment()">Run Environment Check</button>
  </div>
  
  <div class="section">
    <h2>Step 2: Check chrome.storage.local</h2>
    <div id="storage-check"></div>
    <button onclick="checkChromeStorage()">Check Extension Storage</button>
  </div>
  
  <div class="section">
    <h2>Step 3: Check IndexedDB</h2>
    <div id="indexeddb-check"></div>
    <button onclick="checkIndexedDB()">Check Dashboard IndexedDB</button>
  </div>
  
  <div class="section">
    <h2>Step 4: Test Message Listener</h2>
    <div id="message-check"></div>
    <button onclick="testMessageListener()">Test Message Flow</button>
  </div>
  
  <div class="section">
    <h2>Step 5: Manual Sync</h2>
    <div id="sync-check"></div>
    <button onclick="manualSync()">Sync chrome.storage ‚Üí IndexedDB</button>
  </div>

  <script>
    let messageReceived = false;
    
    // Set up message listener
    window.addEventListener('message', (event) => {
      console.log('[Diagnostic] Received message:', event.data);
      if (event.data?.type === 'DIAGNOSTIC_TEST') {
        messageReceived = true;
        document.getElementById('message-check').innerHTML += 
          '<div class="success">‚úÖ Message listener is working!</div>';
      }
    });
    
    function checkEnvironment() {
      const div = document.getElementById('env-check');
      let html = '<div class="step">';
      
      // Check if we're on localhost
      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      html += `<div><span class="check ${isLocalhost ? 'yes' : 'no'}">${isLocalhost ? '‚úÖ' : '‚ùå'}</span>Running on localhost: ${window.location.hostname}</div>`;
      
      // Check if chrome API is available
      const hasChromeAPI = typeof chrome !== 'undefined' && chrome.runtime;
      html += `<div><span class="check ${hasChromeAPI ? 'yes' : 'no'}">${hasChromeAPI ? '‚úÖ' : '‚ùå'}</span>Chrome API available: ${hasChromeAPI}</div>`;
      
      // Check if IndexedDB is available
      const hasIndexedDB = 'indexedDB' in window;
      html += `<div><span class="check ${hasIndexedDB ? 'yes' : 'no'}">${hasIndexedDB ? '‚úÖ' : '‚ùå'}</span>IndexedDB available: ${hasIndexedDB}</div>`;
      
      html += '</div>';
      div.innerHTML = html;
    }
    
    async function checkChromeStorage() {
      const div = document.getElementById('storage-check');
      
      if (typeof chrome === 'undefined' || !chrome.storage) {
        div.innerHTML = '<div class="error">‚ùå Chrome storage API not available</div>';
        return;
      }
      
      try {
        chrome.storage.local.get(['links'], (result) => {
          const links = result.links || [];
          div.innerHTML = `
            <div class="success">
              ‚úÖ Chrome storage accessible<br>
              üì¶ Links in chrome.storage.local: ${links.length}<br>
              <pre>${JSON.stringify(links.slice(0, 2), null, 2)}</pre>
            </div>
          `;
        });
      } catch (e) {
        div.innerHTML = `<div class="error">‚ùå Error: ${e.message}</div>`;
      }
    }
    
    async function checkIndexedDB() {
      const div = document.getElementById('indexeddb-check');
      
      try {
        const request = indexedDB.open('smartResearchDB', 1);
        
        request.onsuccess = (event) => {
          const db = event.target.result;
          const transaction = db.transaction(['links'], 'readonly');
          const store = transaction.objectStore('links');
          const getAllRequest = store.getAll();
          
          getAllRequest.onsuccess = () => {
            const links = getAllRequest.result || [];
            div.innerHTML = `
              <div class="success">
                ‚úÖ IndexedDB accessible<br>
                üì¶ Links in IndexedDB: ${links.length}<br>
                <pre>${JSON.stringify(links.slice(0, 2), null, 2)}</pre>
              </div>
            `;
          };
          
          getAllRequest.onerror = () => {
            div.innerHTML = `<div class="error">‚ùå Error reading from IndexedDB</div>`;
          };
        };
        
        request.onerror = () => {
          div.innerHTML = `<div class="error">‚ùå Error opening IndexedDB</div>`;
        };
      } catch (e) {
        div.innerHTML = `<div class="error">‚ùå Error: ${e.message}</div>`;
      }
    }
    
    function testMessageListener() {
      const div = document.getElementById('message-check');
      messageReceived = false;
      
      div.innerHTML = '<div class="warning">‚è≥ Testing message listener...</div>';
      
      // Send test message
      window.postMessage({ type: 'DIAGNOSTIC_TEST', data: 'test' }, '*');
      
      setTimeout(() => {
        if (messageReceived) {
          div.innerHTML += '<div class="success">‚úÖ Message listener is working!</div>';
        } else {
          div.innerHTML = '<div class="error">‚ùå Message listener not working</div>';
        }
      }, 500);
    }
    
    async function manualSync() {
      const div = document.getElementById('sync-check');
      div.innerHTML = '<div class="warning">‚è≥ Syncing...</div>';
      
      if (typeof chrome === 'undefined' || !chrome.storage) {
        div.innerHTML = '<div class="error">‚ùå Chrome storage not available</div>';
        return;
      }
      
      try {
        chrome.storage.local.get(['links'], async (result) => {
          const extensionLinks = result.links || [];
          
          if (extensionLinks.length === 0) {
            div.innerHTML = '<div class="warning">‚ö†Ô∏è No links in chrome.storage.local to sync</div>';
            return;
          }
          
          // Open IndexedDB
          const request = indexedDB.open('smartResearchDB', 1);
          
          request.onsuccess = async (event) => {
            const db = event.target.result;
            const transaction = db.transaction(['links'], 'readwrite');
            const store = transaction.objectStore('links');
            
            let synced = 0;
            for (const link of extensionLinks) {
              try {
                await store.put(link);
                synced++;
              } catch (e) {
                console.error('Error syncing link:', e);
              }
            }
            
            transaction.oncomplete = () => {
              div.innerHTML = `
                <div class="success">
                  ‚úÖ Manual sync complete!<br>
                  üì¶ Synced ${synced} links from chrome.storage ‚Üí IndexedDB<br>
                  üîÑ Refresh the page to see them!
                </div>
              `;
            };
          };
          
          request.onerror = () => {
            div.innerHTML = '<div class="error">‚ùå Error opening IndexedDB for sync</div>';
          };
        });
      } catch (e) {
        div.innerHTML = `<div class="error">‚ùå Sync error: ${e.message}</div>`;
      }
    }
    
    // Auto-run environment check on load
    window.addEventListener('load', () => {
      checkEnvironment();
    });
  </script>
</body>
</html>

