<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Extension Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { margin: 5px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; max-height: 200px; }
        .log-entry { margin: 5px 0; padding: 5px; border-radius: 3px; }
        .log-info { background: #e7f3ff; }
        .log-success { background: #d4edda; }
        .log-error { background: #f8d7da; }
        .log-warning { background: #fff3cd; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-ok { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-unknown { background: #6c757d; }
    </style>
</head>
<body>
    <h1>üîç Complete Extension Debug</h1>
    <p>This page will test every aspect of the extension to identify the exact problem.</p>
    
    <div class="test-section info">
        <h3>üöÄ Extension Status Check</h3>
        <button onclick="checkExtensionStatus()">Check Extension Status</button>
        <div id="extension-status"></div>
    </div>

    <div class="test-section info">
        <h3>üíæ Storage Access Test</h3>
        <button onclick="testStorageAccess()">Test Storage Access</button>
        <div id="storage-test"></div>
    </div>

    <div class="test-section info">
        <h3>üì° Communication Test</h3>
        <button onclick="testCommunication()">Test Communication</button>
        <div id="communication-test"></div>
    </div>

    <div class="test-section info">
        <h3>üîó Link Management Test</h3>
        <button onclick="testLinkManagement()">Test Link Management</button>
        <div id="link-management-test"></div>
    </div>

    <div class="test-section info">
        <h3>üéØ Dashboard Simulation</h3>
        <button onclick="simulateDashboard()">Simulate Dashboard</button>
        <div id="dashboard-simulation"></div>
    </div>

    <div class="test-section info">
        <h3>üìä Real-time Log</h3>
        <div id="real-time-log" style="background: #f8f9fa; padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto;"></div>
        <button onclick="clearLog()">Clear Log</button>
        <button onclick="exportLog()">Export Log</button>
    </div>

    <script>
        let logEntries = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, message, type };
            logEntries.push(logEntry);
            
            const logDiv = document.getElementById('real-time-log');
            const logElement = document.createElement('div');
            logElement.className = `log-entry log-${type}`;
            logElement.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logDiv.appendChild(logElement);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('real-time-log').innerHTML = '';
            logEntries = [];
        }

        function exportLog() {
            const logText = logEntries.map(entry => `[${entry.timestamp}] ${entry.message}`).join('\n');
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'extension-debug-log.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Test 1: Extension Status Check
        async function checkExtensionStatus() {
            const statusDiv = document.getElementById('extension-status');
            statusDiv.innerHTML = '<p>Checking extension status...</p>';
            
            log('üîç Starting extension status check...');
            
            let status = {
                markers: false,
                chromeRuntime: false,
                chromeStorage: false,
                contentScript: false
            };
            
            // Check for extension markers
            try {
                const hasMarkers = document.documentElement.hasAttribute('data-smart-research-tracker');
                status.markers = hasMarkers;
                log(`Extension markers: ${hasMarkers ? '‚úÖ Found' : '‚ùå Not found'}`);
            } catch (error) {
                log(`Extension markers check failed: ${error.message}`, 'error');
            }
            
            // Check for chrome runtime
            try {
                status.chromeRuntime = typeof chrome !== 'undefined' && chrome.runtime;
                log(`Chrome runtime: ${status.chromeRuntime ? '‚úÖ Available' : '‚ùå Not available'}`);
            } catch (error) {
                log(`Chrome runtime check failed: ${error.message}`, 'error');
            }
            
            // Check for chrome storage
            try {
                status.chromeStorage = typeof chrome !== 'undefined' && chrome.storage && chrome.storage.local;
                log(`Chrome storage: ${status.chromeStorage ? '‚úÖ Available' : '‚ùå Not available'}`);
            } catch (error) {
                log(`Chrome storage check failed: ${error.message}`, 'error');
            }
            
            // Check for content script functions
            try {
                status.contentScript = typeof window.SRTContentScript !== 'undefined';
                log(`Content script: ${status.contentScript ? '‚úÖ Loaded' : '‚ùå Not loaded'}`);
            } catch (error) {
                log(`Content script check failed: ${error.message}`, 'error');
            }
            
            // Display status
            const statusHtml = Object.entries(status).map(([key, value]) => {
                const statusClass = value ? 'success' : 'error';
                const statusIcon = value ? '‚úÖ' : '‚ùå';
                const statusText = value ? 'OK' : 'FAILED';
                return `<div class="${statusClass}"><span class="status-indicator status-${value ? 'ok' : 'error'}"></span>${key}: ${statusIcon} ${statusText}</div>`;
            }).join('');
            
            statusDiv.innerHTML = `
                <h4>Extension Status Summary:</h4>
                ${statusHtml}
                <p><strong>Overall Status:</strong> ${Object.values(status).every(Boolean) ? '‚úÖ Extension is fully functional' : '‚ö†Ô∏è Extension has issues'}</p>
            `;
            
            log(`Extension status check completed. Overall: ${Object.values(status).every(Boolean) ? 'OK' : 'ISSUES FOUND'}`);
        }

        // Test 2: Storage Access Test
        async function testStorageAccess() {
            const testDiv = document.getElementById('storage-test');
            testDiv.innerHTML = '<p>Testing storage access...</p>';
            
            log('üíæ Starting storage access test...');
            
            if (typeof chrome !== 'undefined' && chrome.storage && chrome.storage.local) {
                try {
                    // Test reading
                    const readResult = await new Promise((resolve) => {
                        chrome.storage.local.get(['links', 'labels', 'settings'], resolve);
                    });
                    
                    log(`‚úÖ Storage read successful. Found keys: ${Object.keys(readResult).join(', ')}`);
                    
                    const links = readResult.links || [];
                    const labels = readResult.labels || [];
                    const settings = readResult.settings || {};
                    
                    log(`üìä Storage contents: ${links.length} links, ${labels.length} labels, ${Object.keys(settings).length} settings`);
                    
                    // Test writing
                    const testKey = 'test_' + Date.now();
                    const testValue = { timestamp: Date.now(), test: true };
                    
                    await new Promise((resolve, reject) => {
                        chrome.storage.local.set({ [testKey]: testValue }, () => {
                            if (chrome.runtime.lastError) {
                                reject(chrome.runtime.lastError);
                            } else {
                                resolve();
                            }
                        });
                    });
                    
                    log('‚úÖ Storage write test successful');
                    
                    // Clean up test data
                    await new Promise((resolve) => {
                        chrome.storage.local.remove([testKey], resolve);
                    });
                    
                    log('‚úÖ Storage cleanup successful');
                    
                    testDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Storage Access Test Passed!</h4>
                            <p>Found ${links.length} links, ${labels.length} labels</p>
                            <p>Read/Write operations working correctly</p>
                            ${links.length > 0 ? `<pre>First link: ${JSON.stringify(links[0], null, 2)}</pre>` : ''}
                        </div>
                    `;
                    
                } catch (error) {
                    log(`‚ùå Storage access test failed: ${error.message}`, 'error');
                    testDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Storage Access Test Failed</h4>
                            <p>Error: ${error.message}</p>
                        </div>
                    `;
                }
            } else {
                log('‚ùå Chrome storage not available', 'error');
                testDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Chrome Storage Not Available</h4>
                        <p>This means the extension is not loaded or not accessible</p>
                    </div>
                `;
            }
        }

        // Test 3: Communication Test
        function testCommunication() {
            const testDiv = document.getElementById('communication-test');
            testDiv.innerHTML = '<p>Testing communication...</p>';
            
            log('üì° Starting communication test...');
            
            const messageId = 'comm-test-' + Date.now();
            let responseReceived = false;
            
            const handleResponse = (event) => {
                if (event.data && event.data.type === 'SRT_LINKS_RESPONSE' && event.data.messageId === messageId) {
                    responseReceived = true;
                    const links = event.data.links || [];
                    log(`‚úÖ Communication test successful! Received ${links.length} links`);
                    
                    testDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Communication Test Passed!</h4>
                            <p>Received ${links.length} links from extension</p>
                            <p>PostMessage communication working correctly</p>
                        </div>
                    `;
                    
                    window.removeEventListener('message', handleResponse);
                }
            };
            
            window.addEventListener('message', handleResponse);
            
            // Send test message
            log('üì§ Sending SRT_GET_LINKS test message...');
            window.postMessage({
                type: 'SRT_GET_LINKS',
                messageId: messageId
            }, '*');
            
            // Timeout after 3 seconds
            setTimeout(() => {
                if (!responseReceived) {
                    log('‚ùå Communication test failed: No response received', 'error');
                    testDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Communication Test Failed</h4>
                            <p>No response received from extension</p>
                            <p>This suggests the content script is not loaded or not responding</p>
                        </div>
                    `;
                }
            }, 3000);
        }

        // Test 4: Link Management Test
        async function testLinkManagement() {
            const testDiv = document.getElementById('link-management-test');
            testDiv.innerHTML = '<p>Testing link management...</p>';
            
            log('üîó Starting link management test...');
            
            if (typeof chrome !== 'undefined' && chrome.storage && chrome.storage.local) {
                try {
                    // Create test link
                    const testLink = {
                        id: 'test-link-' + Date.now(),
                        url: 'https://example.com/test-' + Date.now(),
                        metadata: {
                            title: 'Test Link ' + new Date().toLocaleTimeString(),
                            description: 'This is a test link for debugging'
                        },
                        labels: ['test', 'debug'],
                        priority: 'medium',
                        status: 'active',
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    log('‚ûï Creating test link...');
                    
                    // Add link
                    const links = await new Promise((resolve) => {
                        chrome.storage.local.get(['links'], (result) => {
                            const currentLinks = result.links || [];
                            currentLinks.push(testLink);
                            chrome.storage.local.set({ links: currentLinks }, () => {
                                if (chrome.runtime.lastError) {
                                    resolve(null);
                                } else {
                                    resolve(currentLinks);
                                }
                            });
                        });
                    });
                    
                    if (!links) {
                        throw new Error('Failed to add test link');
                    }
                    
                    log(`‚úÖ Test link added successfully. Total links: ${links.length}`);
                    
                    // Verify link was added
                    const verifyResult = await new Promise((resolve) => {
                        chrome.storage.local.get(['links'], resolve);
                    });
                    
                    const verifyLinks = verifyResult.links || [];
                    const addedLink = verifyLinks.find(l => l.id === testLink.id);
                    
                    if (!addedLink) {
                        throw new Error('Test link not found after adding');
                    }
                    
                    log('‚úÖ Link verification successful');
                    
                    // Remove test link
                    const finalLinks = verifyLinks.filter(l => l.id !== testLink.id);
                    await new Promise((resolve) => {
                        chrome.storage.local.set({ links: finalLinks }, resolve);
                    });
                    
                    log('‚úÖ Test link cleanup successful');
                    
                    testDiv.innerHTML = `
                        <div class="success">
                            <h4>‚úÖ Link Management Test Passed!</h4>
                            <p>Successfully created, verified, and removed test link</p>
                            <p>Link CRUD operations working correctly</p>
                        </div>
                    `;
                    
                } catch (error) {
                    log(`‚ùå Link management test failed: ${error.message}`, 'error');
                    testDiv.innerHTML = `
                        <div class="error">
                            <h4>‚ùå Link Management Test Failed</h4>
                            <p>Error: ${error.message}</p>
                        </div>
                    `;
                }
            } else {
                log('‚ùå Chrome storage not available for link management test', 'error');
                testDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Chrome Storage Not Available</h4>
                        <p>Cannot test link management without storage access</p>
                    </div>
                `;
            }
        }

        // Test 5: Dashboard Simulation
        async function simulateDashboard() {
            const testDiv = document.getElementById('dashboard-simulation');
            testDiv.innerHTML = '<p>Simulating dashboard...</p>';
            
            log('üé≠ Starting dashboard simulation...');
            
            try {
                // This is exactly what the dashboard does
                const skipExtension = localStorage.getItem('skipExtensionStorage') === 'true';
                if (skipExtension) {
                    log('üîÑ Skipping extension storage due to clear operation');
                    testDiv.innerHTML = '<div class="warning">Skipping extension storage</div>';
                    return;
                }
                
                let linksFound = false;
                
                // First try direct chrome.storage access
                if (typeof chrome !== 'undefined' && chrome.storage && chrome.storage.local) {
                    try {
                        log('üíæ Trying direct chrome.storage access...');
                        const result = await new Promise((resolve) => {
                            chrome.storage.local.get(['links'], resolve);
                        });
                        
                        if (result.links && result.links.length > 0) {
                            log(`‚úÖ Found ${result.links.length} links using direct storage access`);
                            linksFound = true;
                            
                            testDiv.innerHTML = `
                                <div class="success">
                                    <h4>‚úÖ Dashboard Simulation Success!</h4>
                                    <p>Found ${result.links.length} links using direct storage access</p>
                                    <p>This means your dashboard should work!</p>
                                    <pre>${JSON.stringify(result.links[0], null, 2)}</pre>
                                </div>
                            `;
                            return;
                        }
                    } catch (error) {
                        log(`‚ö†Ô∏è Direct chrome.storage access failed: ${error.message}`, 'warning');
                    }
                }
                
                if (!linksFound) {
                    // Fallback to window.postMessage communication
                    log('üì° Trying window.postMessage communication...');
                    
                    const messageId = 'dashboard-sim-' + Date.now();
                    let responseReceived = false;
                    
                    const handleResponse = (event) => {
                        if (event.data && event.data.type === 'SRT_LINKS_RESPONSE' && event.data.messageId === messageId) {
                            responseReceived = true;
                            const links = event.data.links || [];
                            log(`‚úÖ Dashboard simulation: Received ${links.length} links via postMessage`);
                            
                            testDiv.innerHTML = `
                                <div class="success">
                                    <h4>‚úÖ Dashboard Simulation Success!</h4>
                                    <p>Received ${links.length} links using postMessage fallback</p>
                                    <p>This means your dashboard should work with fallback!</p>
                                </div>
                            `;
                            
                            window.removeEventListener('message', handleResponse);
                        }
                    };
                    
                    window.addEventListener('message', handleResponse);
                    
                    // Request links from extension
                    window.postMessage({
                        type: 'SRT_GET_LINKS',
                        messageId: messageId
                    }, '*');
                    
                    // Timeout after 3 seconds
                    setTimeout(() => {
                        if (!responseReceived) {
                            log('‚ùå Dashboard simulation: No response received', 'error');
                            testDiv.innerHTML = `
                                <div class="error">
                                    <h4>‚ùå Dashboard Simulation Failed</h4>
                                    <p>No links found using any method</p>
                                    <p>This explains why your dashboard shows no links</p>
                                    <p><strong>Possible causes:</strong></p>
                                    <ul>
                                        <li>Extension not properly loaded</li>
                                        <li>Content script not injected</li>
                                        <li>No links saved yet</li>
                                        <li>Communication broken</li>
                                    </ul>
                                </div>
                            `;
                        }
                    }, 3000);
                }
                
            } catch (error) {
                log(`‚ùå Dashboard simulation error: ${error.message}`, 'error');
                testDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Dashboard Simulation Error</h4>
                        <p>Error: ${error.message}</p>
                    </div>
                `;
            }
        }

        // Listen for any messages from the extension
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type) {
                log(`üì® Received message: ${event.data.type}`, 'info');
            }
        });

        // Auto-run basic checks on load
        window.addEventListener('load', () => {
            log('üöÄ Page loaded, starting basic checks...');
            setTimeout(() => {
                checkExtensionStatus();
            }, 1000);
        });
    </script>
</body>
</html>
