<!DOCTYPE html>
<html>
<head>
    <title>Test Extension Flow</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .section {
            background: #252526;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #007acc;
        }
        .success { border-left-color: #4ec9b0; }
        .error { border-left-color: #f48771; }
        .warning { border-left-color: #dcdcaa; }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
            font-family: monospace;
        }
        button:hover {
            background: #1177bb;
        }
        pre {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .step {
            padding: 10px;
            margin: 5px 0;
            background: #2d2d30;
            border-radius: 4px;
        }
        .step.complete { background: #1e3a1e; }
        .step.failed { background: #3a1e1e; }
    </style>
</head>
<body>
    <h1>üî¨ Extension Save Flow Test</h1>
    
    <div class="section">
        <h2>Test Complete Save Flow</h2>
        <p>This will test the entire flow from extension to IndexedDB</p>
        <button onclick="testCompleteSaveFlow()">‚ñ∂Ô∏è Start Test</button>
        <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
    </div>

    <div id="results"></div>

    <script type="module">
        import { db } from './src/db/smartResearchDB.ts';

        const results = document.getElementById('results');
        let stepNumber = 0;

        window.clearResults = function() {
            results.innerHTML = '';
            stepNumber = 0;
        };

        function addStep(message, status = 'pending') {
            stepNumber++;
            const step = document.createElement('div');
            step.className = `step ${status}`;
            step.id = `step-${stepNumber}`;
            step.textContent = `Step ${stepNumber}: ${message}`;
            results.appendChild(step);
            return stepNumber;
        }

        function updateStep(num, message, status) {
            const step = document.getElementById(`step-${num}`);
            if (step) {
                step.textContent = `Step ${num}: ${message}`;
                step.className = `step ${status}`;
            }
        }

        function addDetail(detail, isError = false) {
            const div = document.createElement('pre');
            div.style.color = isError ? '#f48771' : '#4ec9b0';
            div.textContent = detail;
            results.appendChild(div);
        }

        window.testCompleteSaveFlow = async function() {
            clearResults();
            
            try {
                // Step 1: Check if content script is loaded
                const step1 = addStep('Checking if content script is loaded on this page', 'pending');
                const hasContentScript = window.SRTContentScript || window.__SMART_RESEARCH_TRACKER__;
                if (hasContentScript) {
                    updateStep(step1, 'Content script is loaded ‚úì', 'complete');
                } else {
                    updateStep(step1, 'Content script NOT loaded ‚úó', 'failed');
                    addDetail('ERROR: Content script must be loaded for IndexedDB access', true);
                    return;
                }

                // Step 2: Check IndexedDB connection
                const step2 = addStep('Testing IndexedDB connection', 'pending');
                try {
                    const count = await db.links.count();
                    updateStep(step2, `IndexedDB connection OK (${count} existing links) ‚úì`, 'complete');
                } catch (error) {
                    updateStep(step2, `IndexedDB connection FAILED ‚úó`, 'failed');
                    addDetail(`ERROR: ${error.message}`, true);
                    return;
                }

                // Step 3: Create test link
                const step3 = addStep('Creating test link object', 'pending');
                const testLink = {
                    id: crypto.randomUUID(),
                    url: 'https://example.com/test-flow-' + Date.now(),
                    metadata: {
                        title: 'Test Flow Link ' + new Date().toLocaleTimeString(),
                        description: 'Testing complete extension save flow',
                        image: ''
                    },
                    labels: ['test', 'flow'],
                    priority: 'high',
                    status: 'active',
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    source: 'flow-test'
                };
                updateStep(step3, 'Test link created ‚úì', 'complete');
                addDetail(JSON.stringify(testLink, null, 2));

                // Step 4: Simulate content script saving to IndexedDB
                const step4 = addStep('Simulating content script save to IndexedDB', 'pending');
                try {
                    // Use the same method as handleUpsertLink
                    const dbInstance = await window.__SRT_initDB?.() || db;
                    
                    // Check for duplicates
                    const existingLink = await new Promise((resolve, reject) => {
                        const transaction = dbInstance.transaction(['links'], 'readonly');
                        const store = transaction.objectStore('links');
                        const index = store.index('url');
                        const request = index.get(testLink.url);
                        
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                    
                    if (existingLink) {
                        addDetail(`Found existing link: ${existingLink.id}`);
                        testLink.id = existingLink.id;
                        testLink.createdAt = existingLink.createdAt;
                    }

                    // Save to IndexedDB
                    const saveResult = await new Promise((resolve, reject) => {
                        const transaction = dbInstance.transaction(['links'], 'readwrite');
                        const store = transaction.objectStore('links');
                        const request = store.put(testLink);
                        
                        request.onsuccess = () => {
                            resolve({ success: true, link: testLink });
                        };
                        
                        request.onerror = () => {
                            reject(request.error);
                        };
                    });

                    if (saveResult.success) {
                        updateStep(step4, 'Link saved to IndexedDB ‚úì', 'complete');
                    } else {
                        updateStep(step4, 'Link save FAILED ‚úó', 'failed');
                        return;
                    }
                } catch (error) {
                    updateStep(step4, 'IndexedDB save FAILED ‚úó', 'failed');
                    addDetail(`ERROR: ${error.message}\n${error.stack}`, true);
                    return;
                }

                // Step 5: Verify the link was saved
                const step5 = addStep('Verifying link in IndexedDB', 'pending');
                try {
                    const retrieved = await db.getLink(testLink.id);
                    if (retrieved) {
                        updateStep(step5, 'Link verified in IndexedDB ‚úì', 'complete');
                        addDetail(`Retrieved: ${retrieved.metadata.title}`);
                    } else {
                        updateStep(step5, 'Link NOT found in IndexedDB ‚úó', 'failed');
                        return;
                    }
                } catch (error) {
                    updateStep(step5, 'Verification FAILED ‚úó', 'failed');
                    addDetail(`ERROR: ${error.message}`, true);
                    return;
                }

                // Step 6: Trigger dashboard refresh
                const step6 = addStep('Triggering dashboard refresh', 'pending');
                try {
                    window.postMessage({ 
                        type: 'SRT_DB_UPDATED',
                        action: 'create',
                        linkId: testLink.id
                    }, '*');
                    
                    document.dispatchEvent(
                        new CustomEvent('srt-db-updated', { 
                            detail: { 
                                link: testLink,
                                action: 'create'
                            } 
                        })
                    );
                    
                    updateStep(step6, 'Dashboard notifications sent ‚úì', 'complete');
                } catch (error) {
                    updateStep(step6, 'Dashboard notification FAILED (non-critical) ‚ö†', 'warning');
                    addDetail(`WARNING: ${error.message}`, false);
                }

                // Step 7: Final summary
                const step7 = addStep('Test Summary', 'pending');
                const finalCount = await db.links.count();
                updateStep(step7, `‚úÖ ALL TESTS PASSED! Total links in DB: ${finalCount}`, 'complete');
                
                addDetail(`\nüéâ SUCCESS! The complete flow works:\n` +
                         `1. Content script loaded\n` +
                         `2. IndexedDB accessible\n` +
                         `3. Link saved successfully\n` +
                         `4. Link verified in database\n` +
                         `5. Dashboard notified\n\n` +
                         `Now check the dashboard - your test link should appear!`);

            } catch (error) {
                addStep('FATAL ERROR', 'failed');
                addDetail(`ERROR: ${error.message}\n${error.stack}`, true);
            }
        };

        // Auto-run test
        console.log('üî¨ Test page ready. Click "Start Test" to begin.');
    </script>
</body>
</html>

