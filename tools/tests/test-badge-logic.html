<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Badge Logic - Smart Research Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background: #d4edda; color: #155724; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Test Badge Logic - Smart Research Tracker</h1>
    
    <div class="test-section">
        <h2>ğŸ“Š Current Badge Status</h2>
        <p>This page tests the new badge logic that shows only "stuck" links count.</p>
        <div id="badgeStatus" class="status info">Checking badge status...</div>
        <button class="button" onclick="checkBadgeStatus()">ğŸ”„ Refresh Badge Status</button>
        <button class="button" onclick="refreshBadge()">ğŸ”§ Force Badge Update</button>
    </div>

    <div class="test-section">
        <h2>ğŸ”— Test Link Operations</h2>
        <p>Test various scenarios to see how the badge changes:</p>
        <button class="button" onclick="addTestLink()">â• Add Test Link</button>
        <button class="button" onclick="clearAllLinks()">ğŸ—‘ï¸ Clear All Links</button>
        <button class="button" onclick="simulateStuckLinks()">âš ï¸ Simulate Stuck Links</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“‹ Extension Communication Test</h2>
        <p>Test communication with the extension:</p>
        <button class="button" onclick="testExtensionPing()">ğŸ“¡ Ping Extension</button>
        <button class="button" onclick="testGetLinks()">ğŸ“¥ Get Links from Extension</button>
        <div id="communicationStatus" class="status info">Ready to test...</div>
    </div>

    <div class="test-section">
        <h2>ğŸ“š How It Works</h2>
        <h3>Old Badge Logic:</h3>
        <ul>
            <li>Showed total count of all links in extension storage</li>
            <li>Always displayed a number, even when all links were working fine</li>
            <li>Didn't indicate if there were any issues</li>
        </ul>
        
        <h3>New Badge Logic:</h3>
        <ul>
            <li><strong>Red badge with number:</strong> Shows count of "stuck" links (links that exist in extension but aren't displayed on dashboard)</li>
            <li><strong>Green badge with no number:</strong> All links are working properly, no issues detected</li>
            <li><strong>No badge:</strong> No links saved or all links cleared</li>
        </ul>
        
        <h3>What Makes a Link "Stuck":</h3>
        <ul>
            <li>Link exists in extension storage but dashboard can't display it</li>
            <li>Communication issues between extension and dashboard</li>
            <li>Dashboard not running or not accessible</li>
            <li>Data corruption or sync issues</li>
        </ul>
    </div>

    <script>
        // Check if extension is available
        function isExtensionAvailable() {
            return typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.sendMessage;
        }

        // Check badge status
        async function checkBadgeStatus() {
            const statusDiv = document.getElementById('badgeStatus');
            
            if (!isExtensionAvailable()) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = 'âŒ Extension not detected. Make sure Smart Research Tracker is installed.';
                return;
            }

            try {
                statusDiv.className = 'status info';
                statusDiv.innerHTML = 'ğŸ” Checking badge status...';
                
                // Get current links from extension
                const response = await new Promise((resolve) => {
                    chrome.runtime.sendMessage({ type: 'GET_LINKS' }, resolve);
                });
                
                const links = response?.links || [];
                statusDiv.className = 'status success';
                statusDiv.innerHTML = `
                    âœ… Extension detected!<br>
                    ğŸ“Š Total links in storage: ${links.length}<br>
                    ğŸ”´ Badge should show: ${links.length > 0 ? 'Red badge with count of stuck links' : 'No badge (no links)'}<br>
                    ğŸŸ¢ If all links are working: Green badge with no number
                `;
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `âŒ Error checking status: ${error.message}`;
            }
        }

        // Force badge update
        async function refreshBadge() {
            const statusDiv = document.getElementById('badgeStatus');
            
            if (!isExtensionAvailable()) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = 'âŒ Extension not detected.';
                return;
            }

            try {
                statusDiv.className = 'status info';
                statusDiv.innerHTML = 'ğŸ”„ Forcing badge update...';
                
                const response = await new Promise((resolve) => {
                    chrome.runtime.sendMessage({ type: 'REFRESH_BADGE' }, resolve);
                });
                
                if (response?.success) {
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = 'âœ… Badge updated successfully! Check the extension icon.';
                } else {
                    statusDiv.className = 'status warning';
                    statusDiv.innerHTML = 'âš ï¸ Badge update completed but may have failed.';
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `âŒ Error updating badge: ${error.message}`;
            }
        }

        // Add a test link
        async function addTestLink() {
            const statusDiv = document.getElementById('badgeStatus');
            
            if (!isExtensionAvailable()) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = 'âŒ Extension not detected.';
                return;
            }

            try {
                statusDiv.className = 'status info';
                statusDiv.innerHTML = 'â• Adding test link...';
                
                const testLink = {
                    url: `https://example.com/test-${Date.now()}`,
                    title: `Test Link ${new Date().toLocaleTimeString()}`,
                    description: 'This is a test link for badge testing',
                    priority: 'medium',
                    label: 'test'
                };
                
                const response = await new Promise((resolve) => {
                    chrome.runtime.sendMessage({ 
                        type: 'SAVE_LINK', 
                        payload: testLink 
                    }, resolve);
                });
                
                if (response?.success) {
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = `âœ… Test link added! ID: ${response.linkId}<br>Badge should now show red with count of stuck links.`;
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.innerHTML = `âŒ Failed to add test link: ${response?.error || 'Unknown error'}`;
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `âŒ Error adding test link: ${error.message}`;
            }
        }

        // Clear all links
        async function clearAllLinks() {
            const statusDiv = document.getElementById('badgeStatus');
            
            if (!isExtensionAvailable()) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = 'âŒ Extension not detected.';
                return;
            }

            try {
                statusDiv.className = 'status warning';
                statusDiv.innerHTML = 'ğŸ—‘ï¸ Clearing all links...';
                
                const response = await new Promise((resolve) => {
                    chrome.runtime.sendMessage({ type: 'CLEAR_ALL_LINKS' }, resolve);
                });
                
                if (response?.success) {
                    statusDiv.className = 'status success';
                    statusDiv.innerHTML = 'âœ… All links cleared! Badge should now show nothing.';
                } else {
                    statusDiv.className = 'status error';
                    statusDiv.innerHTML = `âŒ Failed to clear links: ${response?.error || 'Unknown error'}`;
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.innerHTML = `âŒ Error clearing links: ${error.message}`;
            }
        }

        // Simulate stuck links scenario
        function simulateStuckLinks() {
            const statusDiv = document.getElementById('badgeStatus');
            statusDiv.className = 'status warning';
            statusDiv.innerHTML = `
                âš ï¸ Simulating stuck links scenario...<br>
                <br>
                To test this:<br>
                1. Add some links using the "Add Test Link" button<br>
                2. Close this dashboard tab<br>
                3. Check the extension badge - it should show red with the count<br>
                4. Reopen this dashboard - badge should turn green with no number<br>
                <br>
                This simulates the real-world scenario where links exist in the extension but aren't displayed on any dashboard.
            `;
        }

        // Test extension communication
        async function testExtensionPing() {
            const commDiv = document.getElementById('communicationStatus');
            
            if (!isExtensionAvailable()) {
                commDiv.className = 'status error';
                commDiv.innerHTML = 'âŒ Extension not detected.';
                return;
            }

            try {
                commDiv.className = 'status info';
                commDiv.innerHTML = 'ğŸ“¡ Pinging extension...';
                
                const response = await new Promise((resolve) => {
                    chrome.runtime.sendMessage({ type: 'SRT_PING' }, resolve);
                });
                
                if (response?.status === 'ok') {
                    commDiv.className = 'status success';
                    commDiv.innerHTML = `
                        âœ… Extension communication successful!<br>
                        ğŸ†” Extension ID: ${response.extensionId}<br>
                        ğŸ“± Source: ${response.source}<br>
                        ğŸ“¦ Version: ${response.version}<br>
                        â° Timestamp: ${new Date(response.timestamp).toLocaleString()}
                    `;
                } else {
                    commDiv.className = 'status warning';
                    commDiv.innerHTML = 'âš ï¸ Extension responded but with unexpected status.';
                }
            } catch (error) {
                commDiv.className = 'status error';
                commDiv.innerHTML = `âŒ Communication failed: ${error.message}`;
            }
        }

        // Test getting links
        async function testGetLinks() {
            const commDiv = document.getElementById('communicationStatus');
            
            if (!isExtensionAvailable()) {
                commDiv.className = 'status error';
                commDiv.innerHTML = 'âŒ Extension not detected.';
                return;
            }

            try {
                commDiv.className = 'status info';
                commDiv.innerHTML = 'ğŸ“¥ Getting links from extension...';
                
                const response = await new Promise((resolve) => {
                    chrome.runtime.sendMessage({ type: 'GET_LINKS' }, resolve);
                });
                
                const links = response?.links || [];
                commDiv.className = 'status success';
                commDiv.innerHTML = `
                    âœ… Successfully retrieved ${links.length} links from extension!<br>
                    ${links.length > 0 ? 'ğŸ”— First link: ' + links[0].url : 'ğŸ“­ No links found'}
                `;
            } catch (error) {
                commDiv.className = 'status error';
                commDiv.innerHTML = `âŒ Failed to get links: ${error.message}`;
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            checkBadgeStatus();
        });
    </script>
</body>
</html>
