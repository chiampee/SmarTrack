<!DOCTYPE html>
<html>
<head>
    <title>Check New Link</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background: #45a049;
        }
        .output {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-left: 4px solid #2196F3;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>üîç Check New Link Diagnostic</h1>
    
    <div class="info">
        <strong>Instructions:</strong>
        <ol>
            <li>Click "Check All Links in Database" to see all saved links</li>
            <li>Look for your newly added link in the list</li>
            <li>Check the total count and compare with what you see in the UI</li>
            <li>If your link is in the database but not showing, there might be a filter issue</li>
        </ol>
    </div>

    <div>
        <button onclick="checkAllLinks()">Check All Links in Database</button>
        <button onclick="checkFilters()">Check Current Filters</button>
        <button onclick="refreshLinks()">Force Refresh Links</button>
        <button onclick="clearFilters()">Clear All Filters</button>
    </div>

    <div id="output" class="output">Results will appear here...</div>

    <script type="module">
        import { db } from './src/db/smartResearchDB.ts';
        import { linkStore } from './src/stores/linkStore.ts';
        import { linkService } from './src/services/linkService.ts';

        const output = document.getElementById('output');

        window.checkAllLinks = async function() {
            try {
                output.textContent = 'Loading links from database...\n\n';
                
                // Get links directly from database
                const dbLinks = await db.links.toArray();
                
                output.textContent = `üìä Database Stats:\n`;
                output.textContent += `Total links in database: ${dbLinks.length}\n\n`;
                
                if (dbLinks.length === 0) {
                    output.textContent += '‚ùå No links found in database!\n';
                    output.textContent += 'This means your new link was not saved.\n';
                    return;
                }
                
                output.textContent += `üìù All Links (sorted by creation date, newest first):\n\n`;
                
                // Sort by creation date (newest first)
                const sortedLinks = [...dbLinks].sort((a, b) => 
                    new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
                );
                
                sortedLinks.forEach((link, index) => {
                    const createdDate = new Date(link.createdAt).toLocaleString();
                    output.textContent += `${index + 1}. ${link.metadata?.title || 'Untitled'}\n`;
                    output.textContent += `   URL: ${link.url}\n`;
                    output.textContent += `   Created: ${createdDate}\n`;
                    output.textContent += `   Labels: ${link.labels?.join(', ') || 'None'}\n`;
                    output.textContent += `   Status: ${link.status || 'None'}\n`;
                    output.textContent += `   Priority: ${link.priority || 'None'}\n`;
                    output.textContent += `\n`;
                });
                
                // Also check what the store shows
                const storeLinks = linkStore.getState().links;
                output.textContent += `\nüìä Store Stats:\n`;
                output.textContent += `Links in store (after filters): ${storeLinks?.length || 0}\n`;
                
                if (dbLinks.length !== storeLinks?.length) {
                    output.textContent += `\n‚ö†Ô∏è WARNING: Database has ${dbLinks.length} links but store shows ${storeLinks?.length}!\n`;
                    output.textContent += `This means filters are hiding some links.\n`;
                }
                
            } catch (error) {
                output.textContent = `‚ùå Error: ${error.message}\n${error.stack}`;
            }
        };

        window.checkFilters = function() {
            const state = linkStore.getState();
            output.textContent = `üîç Current Filters:\n\n`;
            output.textContent += `Status Filter: ${state.statusFilter || 'None'}\n`;
            output.textContent += `Priority Filter: ${state.priorityFilter || 'None'}\n`;
            output.textContent += `Search Term: "${state.searchTerm || ''}"\n`;
            output.textContent += `Sort Key: ${state.sortKey || 'labels'}\n`;
            output.textContent += `Sort Direction: ${state.sortDir || 'asc'}\n`;
            output.textContent += `\nRaw Links Count: ${state.rawLinks?.length || 0}\n`;
            output.textContent += `Filtered Links Count: ${state.links?.length || 0}\n`;
        };

        window.refreshLinks = async function() {
            try {
                output.textContent = 'Refreshing links...\n';
                await linkStore.getState().loadLinks();
                output.textContent += '‚úÖ Links refreshed!\n';
                output.textContent += `Total links now: ${linkStore.getState().links?.length || 0}\n`;
            } catch (error) {
                output.textContent = `‚ùå Error: ${error.message}`;
            }
        };

        window.clearFilters = async function() {
            try {
                output.textContent = 'Clearing filters...\n';
                linkStore.getState().setStatusFilter(undefined);
                linkStore.getState().setPriorityFilter(undefined);
                linkStore.getState().setSearchTerm('');
                await linkStore.getState().loadLinks();
                output.textContent += '‚úÖ Filters cleared and links refreshed!\n';
                output.textContent += `Total links now: ${linkStore.getState().links?.length || 0}\n`;
            } catch (error) {
                output.textContent = `‚ùå Error: ${error.message}`;
            }
        };

        // Auto-check on load
        window.checkAllLinks();
    </script>
</body>
</html>

