<!DOCTYPE html>
<html>
<head>
    <title>Test Database Save</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background: #45a049;
        }
        .output {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            font-size: 12px;
        }
        .error {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }
        .success {
            background: #e8f5e9;
            border-left: 4px solid #4CAF50;
        }
    </style>
</head>
<body>
    <h1>üîß Test Database Save</h1>
    
    <div>
        <button onclick="testDatabaseConnection()">1. Test Database Connection</button>
        <button onclick="testSaveLink()">2. Test Save Link</button>
        <button onclick="checkAllLinks()">3. Check All Links</button>
        <button onclick="testDeleteAll()">4. Delete All (Clean Start)</button>
    </div>

    <div id="output" class="output">Click a button to start testing...</div>

    <script type="module">
        import { db } from './src/db/smartResearchDB.ts';
        import { linkService } from './src/services/linkService.ts';

        const output = document.getElementById('output');

        function log(message, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            if (isError) {
                output.className = 'output error';
            }
        }

        window.testDatabaseConnection = async function() {
            output.textContent = '';
            output.className = 'output';
            
            try {
                log('Testing database connection...');
                
                // Check if Dexie is working
                const dbName = db.name;
                log(`‚úÖ Database name: ${dbName}`);
                
                // Check if tables exist
                const tables = db.tables.map(t => t.name);
                log(`‚úÖ Tables: ${tables.join(', ')}`);
                
                // Try to count links
                const count = await db.links.count();
                log(`‚úÖ Current link count: ${count}`);
                
                // Check if we can access the database
                const canRead = await db.links.toArray();
                log(`‚úÖ Can read from database: ${canRead.length} links`);
                
                log('\n‚úÖ Database connection is working!');
                output.className = 'output success';
                
            } catch (error) {
                log(`‚ùå Database connection failed: ${error.message}`, true);
                log(`Stack: ${error.stack}`);
            }
        };

        window.testSaveLink = async function() {
            output.textContent = '';
            output.className = 'output';
            
            try {
                log('Creating test link...');
                
                const testLink = {
                    id: crypto.randomUUID(),
                    url: 'https://example.com/test-' + Date.now(),
                    metadata: {
                        title: 'Test Link ' + new Date().toLocaleTimeString(),
                        description: 'This is a test link to verify database saving',
                        image: ''
                    },
                    labels: ['test'],
                    priority: 'medium',
                    status: 'active',
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                
                log(`Test link created with ID: ${testLink.id}`);
                log(`URL: ${testLink.url}`);
                
                // Method 1: Direct database save
                log('\nMethod 1: Saving directly to database...');
                await db.addLink(testLink);
                log('‚úÖ Saved to database');
                
                // Verify it's there
                const retrieved = await db.getLink(testLink.id);
                if (retrieved) {
                    log(`‚úÖ Link retrieved from database: ${retrieved.metadata.title}`);
                } else {
                    log('‚ùå Link not found after saving!', true);
                    return;
                }
                
                // Check count
                const count = await db.links.count();
                log(`‚úÖ Total links in database: ${count}`);
                
                // Method 2: Through linkService
                log('\nMethod 2: Saving through linkService...');
                const testLink2 = {
                    id: crypto.randomUUID(),
                    url: 'https://example.com/test-service-' + Date.now(),
                    metadata: {
                        title: 'Test Link (Service) ' + new Date().toLocaleTimeString(),
                        description: 'This is a test link via linkService',
                        image: ''
                    },
                    labels: ['test', 'service'],
                    priority: 'high',
                    status: 'active',
                    createdAt: new Date(),
                    updatedAt: new Date()
                };
                
                await linkService.create(testLink2);
                log(`‚úÖ Saved via linkService: ${testLink2.id}`);
                
                // Verify
                const allLinks = await linkService.getAll();
                log(`‚úÖ Total links via service: ${allLinks.length}`);
                
                log('\n‚úÖ Both save methods working!');
                output.className = 'output success';
                
            } catch (error) {
                log(`‚ùå Save failed: ${error.message}`, true);
                log(`Stack: ${error.stack}`);
                console.error('Full error:', error);
            }
        };

        window.checkAllLinks = async function() {
            output.textContent = '';
            output.className = 'output';
            
            try {
                log('Checking all links in database...\n');
                
                const links = await db.links.toArray();
                log(`Total links: ${links.length}\n`);
                
                if (links.length === 0) {
                    log('‚ùå No links found!', true);
                    return;
                }
                
                links.forEach((link, index) => {
                    log(`${index + 1}. ${link.metadata?.title || 'Untitled'}`);
                    log(`   URL: ${link.url}`);
                    log(`   ID: ${link.id}`);
                    log(`   Created: ${new Date(link.createdAt).toLocaleString()}`);
                    log('');
                });
                
                output.className = 'output success';
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, true);
                log(`Stack: ${error.stack}`);
            }
        };

        window.testDeleteAll = async function() {
            if (!confirm('Are you sure you want to delete ALL links? This cannot be undone!')) {
                return;
            }
            
            output.textContent = '';
            output.className = 'output';
            
            try {
                log('Deleting all links...');
                
                const countBefore = await db.links.count();
                log(`Links before: ${countBefore}`);
                
                await db.links.clear();
                
                const countAfter = await db.links.count();
                log(`Links after: ${countAfter}`);
                
                if (countAfter === 0) {
                    log('\n‚úÖ All links deleted successfully!');
                    output.className = 'output success';
                } else {
                    log('\n‚ùå Some links still remain!', true);
                }
                
            } catch (error) {
                log(`‚ùå Delete failed: ${error.message}`, true);
                log(`Stack: ${error.stack}`);
            }
        };
    </script>
</body>
</html>

