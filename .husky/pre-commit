#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# GitGuardian secret scanning
echo "üîí Scanning for secrets with GitGuardian..."
export PATH="$HOME/.local/bin:$PATH"
if command -v ggshield >/dev/null 2>&1; then
  # Try to scan, but don't block if not authenticated (CI/CD will catch secrets)
  if ggshield secret scan pre-commit 2>/dev/null; then
    echo "‚úÖ GitGuardian scan passed"
  else
    # Check if it's an auth error or a real secret found
    if ggshield auth status >/dev/null 2>&1; then
      # Authenticated but scan failed - likely found secrets
      echo "‚ùå GitGuardian found secrets in your code. Please remove them before committing."
      exit 1
    else
      # Not authenticated - warn but allow commit (CI/CD will check)
      echo "‚ö†Ô∏è  GitGuardian not authenticated. Run 'ggshield auth login' to enable local secret scanning."
      echo "   Commit allowed. Secrets will still be checked in CI/CD via GitHub Actions."
    fi
  fi
elif command -v pipx >/dev/null 2>&1; then
  if pipx run ggshield secret scan pre-commit 2>/dev/null; then
    echo "‚úÖ GitGuardian scan passed"
  else
    echo "‚ö†Ô∏è  GitGuardian CLI not properly configured. Skipping local scan."
    echo "   Commit allowed. Secrets will still be checked in CI/CD via GitHub Actions."
  fi
else
  echo "‚ö†Ô∏è  GitGuardian CLI not found. Install with: pip install ggshield or pipx install ggshield"
  echo "   Commit allowed. Secrets will still be checked in CI/CD via GitHub Actions."
fi

# Lint staged files
npx lint-staged
